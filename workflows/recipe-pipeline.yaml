# BlueprintRecipe Pipeline Workflow
# Triggered by Eventarc when an image is uploaded to:
#   gs://blueprint-8c1ca.appspot.com/scenes/{scene_id}/images/*.jpg
#
# This workflow:
# 1. Extracts scene_id and image path from the GCS event
# 2. Runs the recipe-pipeline Cloud Run Job
# 3. Returns the job execution result

main:
  params: [event]
  steps:
    - init:
        assign:
          - project_id: '${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}'
          - location: "us-central1"
          - job_name: "recipe-pipeline-job"
          - bucket: '${event.data.bucket}'
          - file_name: '${event.data.name}'
          - gcs_uri: '${"gs://" + bucket + "/" + file_name}'

    - log_event:
        call: sys.log
        args:
          text: '${"Received event for file " + gcs_uri}'
          severity: INFO

    - validate_path:
        switch:
          - condition: '${not text.match_regex(file_name, "^scenes/[^/]+/images/.+\\.(jpg|jpeg|png|webp)$")}'
            steps:
              - skip_non_matching:
                  call: sys.log
                  args:
                    text: '${"Skipping non-matching path: " + file_name}'
                    severity: INFO
              - return_skip:
                  return:
                    status: "skipped"
                    reason: "Path does not match pattern scenes/{scene_id}/images/*.jpg"
                    file: '${file_name}'

    - extract_scene_id:
        assign:
          # Extract scene_id from path: scenes/{scene_id}/images/filename.jpg
          - path_parts: '${text.split(file_name, "/")}'
          - scene_id: '${path_parts[1]}'

    - log_processing:
        call: sys.log
        args:
          text: '${"Processing scene " + scene_id + " from image " + gcs_uri}'
          severity: INFO

    - run_pipeline_job:
        call: googleapis.run.v1.namespaces.jobs.run
        args:
          name: '${"namespaces/" + project_id + "/jobs/" + job_name}'
          location: '${location}'
          body:
            overrides:
              containerOverrides:
                - env:
                    - name: IMAGE_URI
                      value: '${gcs_uri}'
                    - name: SCENE_ID
                      value: '${scene_id}'
                    - name: BUCKET
                      value: '${bucket}'
                    - name: GOOGLE_API_KEY
                      value: '${sys.get_env("GOOGLE_API_KEY")}'
        result: job_execution

    - log_job_started:
        call: sys.log
        args:
          text: '${"Started job execution: " + job_execution.metadata.name}'
          severity: INFO

    - wait_for_completion:
        call: googleapis.run.v1.namespaces.executions.get
        args:
          name: '${job_execution.metadata.name}'
          location: '${location}'
        result: execution_status

    - check_completion:
        switch:
          - condition: '${execution_status.status.completionTime != null}'
            next: return_result
          - condition: '${execution_status.status.conditions[0].reason == "ContainerFailed"}'
            steps:
              - log_failure:
                  call: sys.log
                  args:
                    text: '${"Job failed for scene " + scene_id}'
                    severity: ERROR
              - return_failure:
                  return:
                    status: "failed"
                    scene_id: '${scene_id}'
                    execution: '${job_execution.metadata.name}'
        next: wait_loop

    - wait_loop:
        call: sys.sleep
        args:
          seconds: 10
        next: wait_for_completion

    - return_result:
        return:
          status: "complete"
          scene_id: '${scene_id}'
          source_image: '${gcs_uri}'
          output_prefix: '${"gs://" + bucket + "/scenes/" + scene_id + "/recipe/"}'
          execution: '${job_execution.metadata.name}'